import asyncio
from datetime import datetime, timedelta, date
import pytz
from aiogram import Bot, Dispatcher

API_TOKEN = "8284800527:AAGhJrZpK9lLLiRWIKkZ7a-nema2kZnA1Eo"
CHAT_ID = 241144204
TZ = pytz.timezone("Europe/Kyiv")


# -----------------------------
# –°–ü–ò–°–û–ö –ü–†–û–í–ê–î–ñ–ï–ù–¨ –ó –ü–ï–†–Ü–û–î–ò–ß–ù–Ü–°–¢–Æ
# -----------------------------
# —Ñ–æ—Ä–º–∞—Ç:
# ("–ù–∞–∑–≤–∞", datetime(—Ä—ñ–∫, –º—ñ—Å—è—Ü—å, –¥–µ–Ω—å), "month" –∞–±–æ "3month")

CONTROLS = [
    ("–ú–æ–≥–∏–ª–∫–∞ –î.–û. —Ç–∞ —ñ–Ω.", datetime(2025, 7, 5), "3month"),
    ("–°–ª–∞–≤–µ—Ü—å –í.–§. —Ç–∞ —ñ–Ω.", datetime(2025, 7, 6), "3month"),
    ("–Ü–≥–æ–ª–∫—ñ–Ω –û.–ì. —Ç–∞ —ñ–Ω.", datetime(2025, 7, 10), "1month"),  # —Ä–∞–∑ —É –º—ñ—Å—è—Ü—å
    ("–ü–∞–ø –î.–ô. —Ç–∞ —ñ–Ω.", datetime(2025, 7, 15), "3month"),
    ("–ú–µ–¥–µ–Ω—Ü—ñ–π –ú.–ú. —Ç–∞ —ñ–Ω.", datetime(2025, 7, 16), "3month"),
    ("–ë—ñ–ª–∞–∫ –í.–ê. —Ç–∞ —ñ–Ω.", datetime(2025, 7, 18), "3month"),
    ("–ì—ñ—Å–µ–º –ú.–í.", datetime(2025, 7, 21), "3month"),
    ("–ö—ñ–∑–º–∞–Ω –ê.–ê. —Ç–∞ —ñ–Ω.", datetime(2025, 7, 22), "3month"),
    ("–í–µ–∂–¥–µ–ª–æ –í.–Æ. —Ç–∞ —ñ–Ω.", datetime(2025, 7, 23), "3month"),
    ("–•–∞–ª–∞—Ö–∞–Ω –í.–Ü. —Ç–∞ —ñ–Ω.", datetime(2025, 7, 25), "3month"),
    ("–î–∞–Ω–∏–ª–∏—á –†.–í. —Ç–∞ —ñ–Ω.", datetime(2025, 7, 30), "3month"),
    ("–õ–µ–≤–∫—É–ª–∏—á –ú.–í. —Ç–∞ —ñ–Ω.", datetime(2025, 7, 30), "3month"),
    ("–Ø—Ü–∫–∞–Ω–∏—á –í.–Æ. —Ç–∞ —ñ–Ω.", datetime(2025, 7, 30), "3month"),
    ("–í–µ–ª–∏—á–∫–æ –î.–ú. —Ç–∞ —ñ–Ω.", datetime(2025, 8, 3), "3month"),
    ("–ë—Ä–µ–Ω—å–æ –û.–ê., –ö—É–∑—å–º–∞, –ü—É—Ö–æ–≤", datetime(2025, 8, 3), "3month"),
    ("–ü–ª–æ–≤–∞–π–∫–æ –û.–ô. —Ç–∞ —ñ–Ω.", datetime(2025, 8, 7), "3month"),
    ("–ü–∞–ª—å–æ–≤—á–∏–∫ –û.–í. —Ç–∞ —ñ–Ω.", datetime(2025, 8, 9), "3month"),
    ("–ü–∞–≤–ª–∏—à–∏–Ω–µ—Ü—å –í.–Ü. —Ç–∞ —ñ–Ω.", datetime(2025, 8, 9), "3month"),
    ("–ú–∞—Ä–∏–Ω–∞ –í.–ú. —Ç–∞ —ñ–Ω.", datetime(2025, 8, 10), "3month"),
    ("–†–∞—Ü–∏–Ω –†.–ü. —Ç–∞ —ñ–Ω.", datetime(2025, 8, 10), "3month"),
    ("–ö–∞–Ω–∞–ª–æ—à –†.–ú.", datetime(2025, 8, 10), "3month"),
    ("–õ—É—â–∞–∫ –í.–í. —Ç–∞ —ñ–Ω.", datetime(2025, 8, 13), "3month"),
    ("–¢–æ–∫–∞—Ä –í.–°. —Ç–∞ —ñ–Ω.", datetime(2025, 8, 14), "3month"),
    ("–ì–æ—Ä–≤–∞—Ç –Ü.–õ. —Ç–∞ —ñ–Ω.", datetime(2025, 8, 14), "3month"),
    ("–ó–∞—Ä–≥–∞—Ä—è–Ω –ê.–ú. —Ç–∞ —ñ–Ω.", datetime(2025, 8, 14), "3month"),
    ("–ì—É—Ç–∏—á –Ü.–ú. —Ç–∞ —ñ–Ω.", datetime(2025, 8, 14), "3month"),
    ("–ö–æ—Ç–µ–Ω–∫–æ –¢.–û. —Ç–∞ —ñ–Ω.", datetime(2025, 8, 14), "3month"),
    ("–ú–µ—à–∫–æ –°.–Ü. —Ç–∞ —ñ–Ω.", datetime(2025, 8, 14), "3month"),
    ("–ü–æ–≤—ñ–¥–∞–π—á–∏–∫ –Ü.–Ü. —Ç–∞ —ñ–Ω. (—Å—Ç.307)", datetime(2025, 8, 16), "3month"),
    ("–ü—Ä–æ–Ω—ñ–Ω –°.–†. —Ç–∞ —ñ–Ω.", datetime(2025, 8, 16), "3month"),
    ("–§–∞—Ä–∫–∞—à –û.–í. —Ç–∞ —ñ–Ω.", datetime(2025, 8, 17), "3month"),
    ("–ù–∞—É–º–µ–Ω–∫–æ –ê.–ê. —Ç–∞ —ñ–Ω.", datetime(2025, 8, 17), "3month"),
    ("–¶—ñ–ª—è –í.–í. —Ç–∞ —ñ–Ω.", datetime(2025, 8, 19), "3month"),
    ("–Ü–ª—å–Ω–∏—Ü—å–∫–∞ –Ü.–†. —Ç–∞ —ñ–Ω.", datetime(2025, 8, 20), "3month"),
    ("–î–∑—é–Ω—è–∫ –ú.–û.", datetime(2025, 8, 20), "3month"),
    ("–®–µ–ø–µ–ª—å –ê.–í. —Ç–∞ —ñ–Ω.", datetime(2025, 8, 23), "3month"),
    ("–î–∏—á–∫–∞ –í.–í. —Ç–∞ —ñ–Ω.", datetime(2025, 8, 28), "3month"),
    ("–ù–µ–º–µ—à –í.–Ü. —Ç–∞ —ñ–Ω.", datetime(2025, 8, 28), "3month"),
    ("–°—Ç–µ–≥—É—Ä–∞ –¢.–ú. —Ç–∞ —ñ–Ω.", datetime(2025, 8, 28), "3month"),
    ("–ö–æ–Ω–¥—Ä–∞—à –Ü.–í. —Ç–∞ —ñ–Ω.", datetime(2025, 9, 1), "3month"),
    ("–ë–æ–Ω–¥–∞—Ä—é–∫ —Ç–∞ —ñ–Ω.", datetime(2025, 9, 4), "3month"),
    ("–ë–æ–Ω–∫–∞ –°.–í., –ù–µ–º–µ—à", datetime(2025, 9, 4), "3month"),
    ("–ö–∏—Ä–ª–∏–∫ –†.–í. —Ç–∞ —ñ–Ω.", datetime(2025, 9, 4), "3month"),
    ("–ì—É–ª—è—à –ñ.–ñ. —Ç–∞ —ñ–Ω.", datetime(2025, 9, 5), "3month"),
    ("–°—ñ–¥–∞–∫ –û.–Ñ.", datetime(2025, 9, 5), "3month"),
    ("–¢–∫–∞—á–µ–Ω–∫–æ –í.–í. —Ç–∞ —ñ–Ω.", datetime(2025, 9, 5), "3month"),
    ("–õ—É—á–∫–∞ –ú.–î. —Ç–∞ —ñ–Ω.", datetime(2025, 9, 5), "3month"),
    ("–ö—É—Ä—Ç–∞–Ω–∏—á –í.–Ü. —Ç–∞ —ñ–Ω.", datetime(2025, 9, 5), "3month"),
    ("–ß–æ—Ä—ñ–π –û.–Ø.", datetime(2025, 9, 5), "3month"),
    ("–ö—É–ª–∏–∫ –í.–Æ.", datetime(2025, 9, 6), "3month"),
    ("–ë—É—á–∏–Ω–∞ –Ü.–Ü.", datetime(2025, 9, 6), "3month"),
    ("–¢–µ—Ä–ø–∞–∫ –û.–í.", datetime(2025, 9, 6), "3month"),
    ("–ö–æ–≤–∞–ª—å–æ–≤ –¢.–ú.", datetime(2025, 9, 6), "3month"),
    ("–ü–æ–ø–æ–≤–∏—á –ê.–Ü.", datetime(2025, 9, 6), "3month"),
    ("–ñ–∏–¥–µ–Ω–∫–æ –í.–í.", datetime(2025, 9, 6), "3month"),
    ("–ú–æ—Å–∫–∞–ª—å –Ü.–í.", datetime(2025, 9, 7), "3month"),
    ("–¢–µ—Ä–ø–∞–∫ –Ü.–Ü.", datetime(2025, 9, 7), "3month"),
    ("–§—É—Ä–º–∞–Ω –Ü.–í.", datetime(2025, 9, 8), "3month"),
    ("–§–µ–¥–∞—Å–∫–æ –Ø.–ö.", datetime(2025, 9, 8), "3month"),
    ("–ó–æ–∑—É–ª–∏—á –Ü.–Ü.", datetime(2025, 9, 11), "3month"),
    ("–ú—ñ–Ω–∞—î–≤ –ú.–Ü.", datetime(2025, 9, 18), "3month"),
    ("–ü–æ–≤—ñ–¥–∞–π—á–∏–∫ –Ü.–Ü. (2021)", datetime(2025, 9, 19), "3month"),
    ("–ë—É—á–∏–Ω–∞ –Ü.–Ü. (—Å—É–¥)", datetime(2025, 9, 19), "3month"),
    ("–ö—ñ–ª–±–∞ –ú.–ï.", datetime(2025, 9, 20), "3month"),
    ("–ú–∏—à–∫—É–ª–∏–Ω–µ—Ü—å –ú.–ú.", datetime(2025, 9, 20), "3month"),
    ("–î–µ–∫–µ—Ç –ú.–ú.", datetime(2025, 9, 20), "3month"),
    ("–ë–æ—Ä–∫–æ –í.–í.", datetime(2025, 9, 20), "3month"),
    ("–ú–µ–ª—å–Ω–∏–∫ –í.–Ü.", datetime(2025, 9, 20), "3month"),
    ("–¢–æ—Ä –ê.–û.", datetime(2025, 9, 20), "3month"),
    ("–ì–∞–≤—Ä—ñ–ª—É—Ç—Ü –ú.–í.", datetime(2025, 9, 20), "3month"),
    ("–ì–æ—Ä–≤–∞—Ç –ö.–í.", datetime(2025, 9, 20), "3month"),
    ("–ì–∞–π–¥—É—á–∞–∫ –ú.", datetime(2025, 9, 20), "3month"),
    ("–ï–Ω–≥–ª–µ—Ä—Ç –ö.–ê.", datetime(2025, 9, 20), "3month"),
    ("–ì–∞–±–æ–≤–¥–∞ –ú.–ú.", datetime(2025, 9, 20), "3month"),
    ("–•—Ä–∞–Ω—é–∫ –ë.–ë.", datetime(2025, 9, 20), "3month"),
    ("–ù–µ—Å—É—Ö –õ.–ú.", datetime(2025, 9, 20), "3month"),
    ("–ü–µ—á–∫–æ –í.–Æ.", datetime(2025, 9, 21), "3month"),
    ("–ù–∏–∫–∏—Ñ–æ—Ä—É–∫ –Ø.–°.", datetime(2025, 9, 21), "3month"),
    ("–ï–Ω–¥—Ä–µ–∫ –û.–¢.", datetime(2025, 9, 21), "3month"),
    ("–ñ—É—Ä–∫–æ –Æ.–ß.", datetime(2025, 9, 28), "3month"),
    ("–¢–æ–π –û.–Ø.", datetime(2025, 9, 30), "3month"),
    ("–í–∞–Ω—å–∫–æ–≤ –í.–í.", datetime(2025, 9, 30), "3month")
]

def add_period(date_obj, period):
    """–î–æ–¥–∞—î –ø–µ—Ä—ñ–æ–¥ –¥–æ –¥–∞—Ç–∏"""
    if period == "3month":
        return date_obj + timedelta(days=90)
    if period == "1month":
        return date_obj + timedelta(days=30)
    return date_obj


async def send_reminder(bot, text):
    await bot.send_message(CHAT_ID, text, parse_mode="Markdown")


async def check_loop(bot):
    """–û—Å–Ω–æ–≤–Ω–∏–π —Ü–∏–∫–ª –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –¥–µ–¥–ª–∞–π–Ω—ñ–≤"""
    while True:
        now = datetime.now(TZ).date()

        for idx, (name, deadline, period) in enumerate(CONTROLS):

            d = deadline.date()
            days_left = (d - now).days

            # –ù–∞–≥–∞–¥—É–≤–∞–Ω–Ω—è –∑–∞ 3 –¥–Ω—ñ
            if days_left == 3:
                await send_reminder(
                    bot,
                    f"üîî *–ù–∞–≥–∞–¥—É–≤–∞–Ω–Ω—è –∑–∞ 3 –¥–Ω—ñ*\nüìÅ {name}\n‚è≥ –°—Ç—Ä–æ–∫: {d.strftime('%d.%m.%Y')}"
                )

            # –ù–∞–≥–∞–¥—É–≤–∞–Ω–Ω—è –∑–∞ 1 –¥–µ–Ω—å
            if days_left == 1:
                await send_reminder(
                    bot,
                    f"‚ö†Ô∏è *–ö–æ–Ω—Ç—Ä–æ–ª—å–Ω–µ –Ω–∞–≥–∞–¥—É–≤–∞–Ω–Ω—è ‚Äî 1 –¥–µ–Ω—å!*\nüìÅ {name}\n‚è≥ –°—Ç—Ä–æ–∫: {d.strftime('%d.%m.%Y')}"
                )

            # –°—Ç—Ä–æ–∫ –Ω–∞—Å—Ç–∞–≤ ‚Äî –ø–µ—Ä–µ–Ω–æ—Å–∏–º–æ –Ω–∞ –Ω–∞—Å—Ç—É–ø–Ω–∏–π —Ü–∏–∫–ª
            if days_left == 0:
                new_deadline = add_period(deadline, period)
                CONTROLS[idx] = (name, new_deadline, period)

                await send_reminder(
                    bot,
                    f"üîÑ *–°—Ç—Ä–æ–∫ –æ–Ω–æ–≤–ª–µ–Ω–æ*\nüìÅ {name}\n‚û°Ô∏è –ù–æ–≤–∏–π —Å—Ç—Ä–æ–∫: {new_deadline.strftime('%d.%m.%Y')}"
                )

        await asyncio.sleep(24 * 60 * 60)   # —Ä–∞–∑ –Ω–∞ –¥–µ–Ω—å


async def main():
    bot = Bot(token=API_TOKEN)
    dp = Dispatcher()

    await send_reminder(bot, "ü§ñ –ë–æ—Ç –∫–æ–Ω—Ç—Ä–æ–ª—é —Å—Ç—Ä–æ–∫—ñ–≤ –∑–∞–ø—É—â–µ–Ω–æ!")

    asyncio.create_task(check_loop(bot))
    await dp.start_polling(bot)


if __name__ == "__main__":
    asyncio.run(main())

